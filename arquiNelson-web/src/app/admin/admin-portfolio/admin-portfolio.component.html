<section class="portfolio-admin">
  <header>
    <div>
      <h2>Portafolio</h2>
      <p>Define el orden de los proyectos visibles en el portafolio.</p>
    </div>
    <button type="button" (click)="toggleAdd()">
      {{ showAdd ? 'Cerrar' : 'Agregar proyecto' }}
    </button>
  </header>

  <div class="panel" *ngIf="showAdd">
    <h3>Agregar al portafolio</h3>
    <div class="form-grid">
      <label>
        Proyecto
        <select [(ngModel)]="addDraft.projectId" (change)="onProjectSelect()">
          <option [ngValue]="0">Selecciona un proyecto</option>
          <option *ngFor="let project of availableProjects" [ngValue]="project.id">
            {{ project.name }}
          </option>
        </select>
      </label>
      <label>
        Orden
        <input type="number" min="0" step="1" [(ngModel)]="addDraft.sortOrder" />
      </label>
      <label>
        Titulo en portafolio
        <input [(ngModel)]="addDraft.titleOverride" placeholder="Opcional" />
      </label>
      <label>
        Categoria
        <input [(ngModel)]="addDraft.category" placeholder="Residencial, Comercial..." />
      </label>
      <label class="full">
        Resumen
        <textarea rows="3" [(ngModel)]="addDraft.summary" placeholder="Descripcion corta"></textarea>
      </label>
      <label class="full">
        Link Autocad 360
        <input [(ngModel)]="addDraft.autocadUrl" placeholder="https://a360.co/..." />
      </label>
      <label>
        Visible
        <select [(ngModel)]="addDraft.isVisible">
          <option [ngValue]="true">Visible</option>
          <option [ngValue]="false">Oculto</option>
        </select>
      </label>
      <button type="button" (click)="addEntry()" [disabled]="saving">
        Agregar
      </button>
    </div>

    <div class="subpanel">
      <h4>Imagen de portada</h4>
      <div class="image-uploader">
        <div class="image-preview" *ngIf="addDraft.coverImage">
          <img [src]="addDraft.coverImage.fileUrl" alt="Portada" />
          <button type="button" class="ghost" (click)="removeAddCover()">Quitar</button>
        </div>
        <label class="upload">
          Subir imagen
          <input type="file" accept="image/*" (change)="uploadAddCover($event)" />
        </label>
      </div>
    </div>

    <div class="subpanel">
      <h4>Imagenes principales</h4>
      <div class="image-list">
        <div class="image-card" *ngFor="let img of addDraft.heroImages; let i = index">
          <img [src]="img.fileUrl" alt="Hero" />
          <div class="image-actions">
            <button type="button" class="danger" (click)="removeAddHero(i)">Eliminar</button>
          </div>
        </div>
      </div>
      <label class="upload">
        Agregar imagen
        <input type="file" accept="image/*" (change)="uploadAddHero($event)" />
      </label>
    </div>

    <div class="subpanel">
      <h4>Especificaciones</h4>
      <div class="spec-grid">
        <div class="spec-row" *ngFor="let spec of addDraft.specs; let i = index">
          <input [(ngModel)]="spec.label" placeholder="Etiqueta" />
          <input [(ngModel)]="spec.value" placeholder="Valor" />
          <button type="button" class="danger" (click)="removeAddSpec(i)">Quitar</button>
        </div>
      </div>
      <button type="button" class="ghost" (click)="addAddSpec()">Agregar especificacion</button>
    </div>

    <div class="subpanel">
      <h4>Tags</h4>
      <div class="tag-editor">
        <input [(ngModel)]="newTag" placeholder="Nuevo tag" />
        <button type="button" (click)="addAddTag()">Agregar</button>
      </div>
      <div class="tag-list">
        <span class="tag" *ngFor="let tag of addDraft.tags; let i = index">
          {{ tag }}
          <button type="button" (click)="removeAddTag(i)">x</button>
        </span>
      </div>
    </div>

    <div class="subpanel">
      <h4>Galeria</h4>
      <div class="image-list">
        <div class="image-card" *ngFor="let img of addDraft.galleryImages; let i = index">
          <img [src]="img.fileUrl" alt="Galeria" />
          <div class="image-actions">
            <button type="button" class="danger" (click)="removeAddGallery(i)">Eliminar</button>
          </div>
        </div>
      </div>
      <label class="upload">
        Agregar imagen
        <input type="file" accept="image/*" (change)="uploadAddGallery($event)" />
      </label>
    </div>

    <p class="hint" *ngIf="!availableProjects.length">No hay proyectos disponibles.</p>
  </div>

  <p class="error" *ngIf="error">{{ error }}</p>

  <div class="table">
    <div class="table-row table-header">
      <span>Orden</span>
      <span>Proyecto</span>
      <span>Titulo</span>
      <span>Visible</span>
      <span>Acciones</span>
    </div>
    <div class="table-row" *ngIf="loading">
      <span>Cargando...</span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
    </div>
    <div class="table-row" *ngFor="let entry of entries">
      <input type="number" min="0" step="1" [(ngModel)]="entry.draft.sortOrder" />
      <span>{{ entry.project }}</span>
      <input [(ngModel)]="entry.draft.titleOverride" placeholder="Opcional" />
      <select [(ngModel)]="entry.draft.isVisible">
        <option [ngValue]="true">Visible</option>
        <option [ngValue]="false">Oculto</option>
      </select>
      <div class="actions">
        <a class="secondary" [routerLink]="['/admin/portfolio', entry.id]">Editar</a>
        <button type="button" (click)="saveEntry(entry)" [disabled]="saving">Guardar</button>
        <button type="button" class="danger" (click)="removeEntry(entry)" [disabled]="saving">
          Quitar
        </button>
      </div>
    </div>
    <div class="table-row" *ngIf="!loading && !entries.length">
      <span>Sin proyectos en portafolio.</span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
    </div>
  </div>
</section>
