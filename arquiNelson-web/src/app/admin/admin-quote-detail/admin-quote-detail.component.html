<section class="quote-detail">
  <a class="back-link" routerLink="/admin/quotes">Volver a cotizaciones</a>

  <header class="header">
    <div>
      <h2>Cotizacion #{{ quote?.id }}</h2>
      <p *ngIf="quote">Estado actual: {{ formatStatus(quote.status) }}</p>
    </div>
  </header>

  <p class="hint" *ngIf="loading">Cargando cotizacion...</p>
  <p class="error" *ngIf="error">{{ error }}</p>

  <ng-container *ngIf="quote">
    <div class="panel-grid">
      <div class="panel">
        <h3>Datos de la cotizacion</h3>
        <div class="form-grid">
          <label>
            N° Cotizacion
            <input name="quoteId" [value]="quote.id" readonly />
          </label>
          <label>
            Estado
            <select name="status" [(ngModel)]="draft.status">
              <option value="new">Nueva</option>
              <option value="reviewed">Revisada</option>
              <option value="sent">Enviada</option>
              <option value="accepted">Aceptada</option>
              <option value="rejected">Rechazada</option>
            </select>
          </label>
          <label>
            Fecha creacion
            <input name="createdAt" [value]="quote.createdAt | date: 'dd/MM/yyyy'" readonly />
          </label>
          <label>
            Vigente hasta
            <input name="expiresAt" type="date" [(ngModel)]="draft.expiresAt" />
          </label>
        </div>
      </div>

      <div class="panel">
        <h3>Datos del cliente</h3>
        <div class="form-grid">
          <label>
            Tipo documento
            <select name="documentType" [(ngModel)]="draft.documentType">
              <option *ngFor="let doc of docTypes" [value]="doc.value">{{ doc.label }}</option>
            </select>
          </label>
          <label>
            N° documento
            <input name="documentNumber" [(ngModel)]="draft.documentNumber" />
          </label>
          <label>
            Nombre completo
            <input name="fullName" [(ngModel)]="draft.fullName" />
          </label>
          <label>
            Telefono
            <input name="phone" [(ngModel)]="draft.phone" />
          </label>
          <label class="wide">
            Correo
            <input name="email" type="email" [(ngModel)]="draft.email" />
          </label>
        </div>
      </div>
    </div>

    <div class="panel-grid">
      <div class="panel">
        <h3>Datos del proyecto</h3>
        <div class="form-grid">
          <label>
            Nombre del proyecto
            <input name="projectName" [(ngModel)]="draft.projectName" />
          </label>
          <label class="wide">
            Direccion
            <input name="projectAddress" [(ngModel)]="draft.projectAddress" />
          </label>
          <label>
            Area total (m2)
            <input
              name="areaM2"
              type="number"
              min="0"
              step="0.01"
              [(ngModel)]="draft.areaM2"
              (input)="updateAreaCovered()"
            />
          </label>
          <label>
            Area libre (%)
            <input
              name="areaUncoveredPercent"
              type="number"
              min="0"
              max="100"
              step="0.01"
              [(ngModel)]="draft.areaUncoveredPercent"
              (input)="updateAreaCovered()"
            />
          </label>
          <label>
            Area libre (m2)
            <input
              name="areaUncoveredM2"
              type="number"
              [value]="getAreaUncoveredM2()"
              readonly
            />
          </label>
          <label>
            Area techada (m2)
            <input name="areaCoveredM2" type="number" [value]="draft.areaCoveredM2" readonly />
          </label>
          <label>
            N° pisos
            <input name="floorCount" type="number" min="0" step="1" [(ngModel)]="draft.floorCount" />
          </label>
        </div>
      </div>

      <div class="panel">
        <h3>Datos del plan</h3>
        <div class="form-grid">
          <label>
            Plan
            <select name="pricingRateId" [(ngModel)]="draft.pricingRateId" (change)="onRateChange()">
              <option [ngValue]="null">Manual</option>
              <option *ngFor="let rate of rates" [ngValue]="rate.id">
                {{ rate.name }} ({{ rate.basePricePerM2 }} {{ rate.currency }})
              </option>
            </select>
          </label>
          <label>
            Nombre del plan
            <input name="planName" [(ngModel)]="draft.planName" [readonly]="!!draft.pricingRateId" />
          </label>
          <label>
            Costo x m2 ({{ draft.currency }})
            <input
              name="baseRatePerM2"
              type="number"
              min="0"
              step="0.01"
              [(ngModel)]="draft.baseRatePerM2"
              [readonly]="!!draft.pricingRateId"
            />
          </label>
          <label>
            Plazo minimo (dias)
            <input
              name="planMinDays"
              type="number"
              min="0"
              step="1"
              [(ngModel)]="draft.planMinDays"
              [readonly]="!!draft.pricingRateId"
            />
          </label>
          <label>
            Plazo maximo (dias)
            <input
              name="planMaxDays"
              type="number"
              min="0"
              step="1"
              [(ngModel)]="draft.planMaxDays"
              [readonly]="!!draft.pricingRateId"
            />
          </label>
        </div>
      </div>
    </div>

    <div class="panel">
      <h3>Resumen de costos</h3>
      <div class="summary">
        <div>
          <span>Base</span>
          <strong>{{ formatCurrency(quote.baseCost, quote.currency) }}</strong>
        </div>
        <div>
          <span>Extras</span>
          <strong>{{ formatCurrency(quote.extrasCost, quote.currency) }}</strong>
        </div>
        <div>
          <span>Total</span>
          <strong>{{ formatCurrency(quote.totalCost, quote.currency) }}</strong>
        </div>
      </div>
      <label class="wide">
        Notas internas
        <textarea name="notes" rows="3" [(ngModel)]="draft.notes"></textarea>
      </label>
    </div>

    <div class="panel">
      <h3>Servicios extra</h3>
      <div class="service-list" *ngIf="services.length; else emptyServices">
        <article class="service-row" *ngFor="let service of services">
          <div>
            <h4>{{ service.name }}</h4>
            <p>Tipo: {{ service.pricingType }}</p>
          </div>
          <div class="service-controls">
            <label>
              Cantidad
              <input type="number" min="1" step="0.01" [(ngModel)]="service.draft.quantity" />
            </label>
            <label>
              Precio
              <input type="number" min="0" step="0.01" [(ngModel)]="service.draft.unitPrice" />
            </label>
            <div class="line-total">
              {{ formatCurrency(service.lineTotal, quote.currency) }}
            </div>
            <div class="actions">
              <button type="button" (click)="saveService(service)">Guardar</button>
              <button type="button" class="danger" (click)="deleteService(service)">Eliminar</button>
            </div>
          </div>
        </article>
      </div>
      <ng-template #emptyServices>
        <p class="hint">No hay servicios extra aun.</p>
      </ng-template>

      <div class="add-service">
        <h4>Agregar servicio</h4>
        <div class="form-grid compact">
          <label>
            Servicio
            <select [(ngModel)]="serviceDraft.serviceId" (change)="onServiceChange()">
              <option [ngValue]="0">Selecciona un servicio</option>
              <option *ngFor="let service of serviceOptions" [ngValue]="service.id">
                {{ service.name }} ({{ service.price }} {{ service.currency }})
              </option>
            </select>
          </label>
          <label>
            Cantidad
            <input type="number" min="1" step="0.01" [(ngModel)]="serviceDraft.quantity" />
          </label>
          <label>
            Precio
            <input type="number" min="0" step="0.01" [(ngModel)]="serviceDraft.unitPrice" />
          </label>
          <button type="button" (click)="addService()">Agregar</button>
        </div>
      </div>
    </div>

    <div class="footer-actions">
      <button type="button" (click)="saveQuote()" [disabled]="saving || loading">
        Guardar cambios
      </button>
    </div>
  </ng-container>
</section>
